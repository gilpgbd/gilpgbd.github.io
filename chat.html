<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport"
      content="width=device-width,
       initial-scale=1.0">
    <title>Chat</title>
    <script
      src="https://www.gstatic.com/firebasejs/8.2.3/firebase-app.js"></script>
    <script
      src="https://www.gstatic.com/firebasejs/8.2.3/firebase-auth.js"></script>
    <script
      src="https://www.gstatic.com/firebasejs/8.2.3/firebase-firestore.js"></script>
    <script src="js/init.js">
    </script>
    <script type="module"
      src="cmp/mi-nav.js">
      </script>
    <script type="module"
      src="cmp/mi-footer.js">
      </script>
    <script type="module"
      src="cmp/mi-progreso.js">
      </script>
    <link rel="stylesheet"
      href="css/estilos.css">
  </head>
  <body>
    <mi-nav></mi-nav>
    <form id="forma">
      <header>
        <h1>Chat</h1>
        <div class="herramientas">
          <input name="texto"
            required
            placeholder="Mensaje">
          <button>Enviar</button>
        </div>
      </header>
      <ul id="lista"
        class="lista">
        <li>
          <mi-progreso>
          </mi-progreso>
        </li>
      </ul>
      <mi-footer></mi-footer>
    </form>
    <script type="module">
      import {
        cod, muestraError
      } from "./js/util.js";
      import {
        iniciaSesión,
        cargaRoles,
        noAutorizado
      } from "./js/seguridad.js";
      /** Nombre de usuario
       * autenticado por Firebase.
       */
      const auth =
        firebase.auth();
      const firestore =
        firebase.firestore();
      let usuarioId = "";
      let html = "";
      auth.onAuthStateChanged(
        protege, muestraError);

      /** @param {Object} usuario */
      async function protege(
        usuario) {
        if (usuario &&
          usuario.email) {
          usuarioId =
            usuario.email;
          const roles =
            await cargaRoles(
              usuarioId);
          if (roles.has(
            "Cliente")) {
            consulta();
            forma.
              addEventListener(
                "submit", agrega);
          } else {
            noAutorizado();
          }
        } else {
          iniciaSesión();
        }
      }
      /** Agrega un usuario a la
       * base de datos.
       * @param {Event} evt */
      async function agrega(evt) {
        try {
          evt.preventDefault();
          const formData =
            new FormData(forma);
          const texto = formData.
            get("texto").trim();
          const timestamp =
            firebase.firestore.
              FieldValue.
              serverTimestamp();
          /* Crea un objeto con
           * los campos que se
           * agregan a la base de
           * datos. Los campos son
           * "usuarioId", "texto"
           * y "timestamp".
           * El timestamp contiene
           * la fecha y hora en
           * que se agrega el
           * registro.*/
          const modelo = {
            usuarioId,
            texto,
            timestamp
          };
          /* El modelo se agrega a
           * la colección
           * "Mensaje". */
          await firestore.
            collection("Mensaje").
            add(modelo);
          forma.texto.value = "";
        } catch (e) {
          muestraError(e);
        }
      }
      /** Muestra los mensajes
       * almacenados en la
       * collection "Mensaje". Se
       * actualiza
       * automáticamente. */
      function consulta() {
        /* Consulta que se
         * actualiza
         * automáticamente. Pide
         * todos los registros de
         * la colección "Mensaje"
         * ordenados por el campo
         * "timestamp" de forma
         * descendente. */
        firestore.
          collection("Mensaje").
          orderBy(
            "timestamp", "desc")
          .onSnapshot(
            rnLista,
            errConsulta);
      }
      /** Función que
       * muestra los datos
       * enviados por el servidor.
       * Si los datos cambian en
       * el servidor, se vuelve a
       * invocar esta función y
       * recibe los datos
       * actualizados.
       * @param {Object} res estructura
       *  parecida a un Array, que
       *  contiene una copia de
       *  los datos del servidor.
       */
      function rnLista(res) {
        html = "";
        if (res.size > 0) {
          /* Cuando el número de
           * documentos devueltos
           * por la consulta es
           * mayor que 0, revisa
           * uno por uno los
           * documentos de la
           * consulta y los
           * muestra. El iterador
           * "doc" apunta a un
           * documento de la base
           * de datos. */
          res.forEach(rnFila);
        } else {
          /* Cuando el número de
           * registros devueltos
           * por la consulta es
           * mayor que 0, agrega
           * un texto HTML. */
          html += /* html */
            `<li>
              No hay mensajes
              registrados.
            </li>`;
        }
        lista.innerHTML = html;
      }
      /** Agrega el texto HTML
       * que corresponde a un
       * documento de un mensaje.
       * @param {Object} doc */
      function rnFila(doc) {
        /* Recupera los datos del
         * documento. */
        const data = doc.data();
        /* Agrega un li con los
         * datos del documento,
         * los cuales se codifican
         * para evitar inyección
         * de código. */
        html += /* html */
          `<li class="fila">
            <strong
              class="primario">
              ${cod(
            data.usuarioId)}
            </strong>
            <span
              class="secundario">
              ${cod(
              data.texto)}
            </span>
          </li>`;
      }
      /* Función que se invoca
       * cuando hay un error al
       * recuperar los mensajes.
       * Muestra el error. Al
       * invocar esta función, la
       * conexión se cancela; por
       * lo mismo, intenta
       * conectarse otra vez.
       * @param {Error} e */
      function errConsulta(e) {
        procesaError(e);
        /* Intenta conectarse otra
         * vez. */
        consulta();
      }
    </script>
  </body>
</html>