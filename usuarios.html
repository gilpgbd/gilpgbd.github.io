<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport"
      content="width=device-width,
       initial-scale=1.0">
    <title>Usuarios</title>
    <script
      src="https://www.gstatic.com/firebasejs/8.2.3/firebase-app.js"></script>
    <script
      src="https://www.gstatic.com/firebasejs/8.2.3/firebase-auth.js"></script>
    <script
      src="https://www.gstatic.com/firebasejs/8.2.3/firebase-firestore.js"></script>
    <!-- Agrega el manejo de storage. -->
    <script
      src="https://www.gstatic.com/firebasejs/8.2.3/firebase-storage.js"></script>
    <script src="js/init.js">
    </script>
    <script type="module"
      src="cmp/mi-nav.js">
      </script>
    <script type="module"
      src="cmp/mi-footer.js">
      </script>
    <script type="module"
      src="cmp/mi-progreso.js">
      </script>
    <link rel="stylesheet"
      href="css/estilos.css">
  </head>
  <body>
    <mi-nav></mi-nav>
    <header>
      <h1>Usuarios</h1>
      <div class="herramientas">
        <a href="usuarioNuevo.html">
          Agregar…</a>
      </div>
    </header>
    <ul id="lista" class="lista">
      <li>
        <mi-progreso>
        </mi-progreso>
      </li>
    </ul>
    <mi-footer></mi-footer>
    <script type="module">
      import {
        cod, muestraError
      } from "./js/util.js";
      import {
        muestraPasatiempos
      } from "./js/navegacion.js";
      import {
        iniciaSesión,
        cargaRoles,
        noAutorizado
      } from "./js/seguridad.js";
      import {
        renderRol
      } from "./js/usuarios.js";
      import {
        urlStorage
      } from "./js/storage.js";
      const auth =
        firebase.auth();
      const firestore =
        firebase.firestore();
      let html = "";
      auth.onAuthStateChanged(
        protege, muestraError);

      async function protege(
        usuario) {
        if (usuario &&
          usuario.email) {
          const roles =
            await cargaRoles(
              usuario.email);
          if (roles.has(
            "Administrador")) {
            consulta();
          } else {
            noAutorizado();
          }
        } else {
          iniciaSesión();
        }
      }
      function consulta() {
        firestore.collection("Usuario")
          .onSnapshot(
            rnLista,
            errConsulta);
      }
      async function
        rnLista(res) {
        html = "";
        if (res.size > 0) {
          /** @type {Promise<string>[]} */
          let usuarios = [];
          res.forEach(
            doc => usuarios.
              push(rnFila(doc)));
          const renderDeUsuarios =
            await Promise.all(
              usuarios);
          /* Junta el todos los
           * elemento del arreglo
           * en una cadena. */
          html +=
            renderDeUsuarios.
              join("");
        } else {
          html += /* html */
            `<li>
              No hay usuarios
              registrados.
            </li>`;
        }
        lista.innerHTML = html;
      }
      async function rnFila(doc) {
        const data = doc.data();
        const img = cod(
          await urlStorage(
            doc.id));
        const pasatiempo =
          cod(await rnPas(
            data.pasatiempoId));
        const roles =
          await rnRls(
            data.rolIds);
        const parámetros =
          new URLSearchParams();
        parámetros.append(
          "id", doc.id);
        return (/* html */
          `<li>
            <a class="fila
              conImagen"
              href="usuario.html?${parámetros}">
              <span class="marco">
                <img src="${img}"
                  alt="Falta el
                   Avatar">
              </span>
              <span class="texto">
                <span
                 class="primario">
                  ${cod(doc.id)}
                </span>
                <span
                 class="secundario">
                  ${pasatiempo}
                  <br>
                  ${roles}
                </span>
              </span>
            </a>
          </li>`);
      }
      /** Recupera el html de un
       * pasatiempo en base a su
       * id.
       * @param {string} id */
      async function rnPas(id) {
        if (id) {
          const doc =
            await firestore.
              collection(
                "Pasatiempo").
              doc(id).
              get();
          if (doc.exists) {
            const data =
              doc.data();
            return cod(
              data.nombre);
          }
        }
        return (
          "-- Sin Pasatiempo --");
      }
      /** Recupera el html de los
       * roles en base a sus id
       * @param {string[]} ids */
      async function rnRls(ids) {
        let html = "";
        if (ids &&
          ids.length > 0) {
          for (const id of ids) {
            const docRol =
              await firestore.
                collection("Rol").
                doc(id).
                get();
            html +=
              renderRol(docRol) +
              "<br>";
          }
          return html;
        } else {
          return (
            "-- Sin Roles --");
        }
      }
      function errConsulta(e) {
        procesaError(e);
        consulta();
      }
    </script>
  </body>
</html>