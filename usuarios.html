<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuarios</title>
    <script
      src="https://www.gstatic.com/firebasejs/8.2.3/firebase-app.js"></script>
    <script
      src="https://www.gstatic.com/firebasejs/8.2.3/firebase-auth.js"></script>
    <script
      src="https://www.gstatic.com/firebasejs/8.2.3/firebase-firestore.js"></script>
    <!-- Agrega el manejo de storage. -->
    <script
      src="https://www.gstatic.com/firebasejs/8.2.3/firebase-storage.js"></script>
    <script src="js/init.js"></script>
    <script type="module" src="cmp/mi-nav.js"></script>
    <script type="module" src="cmp/mi-footer.js"></script>
    <script type="module" src="cmp/mi-progreso.js"></script>
    <link rel="stylesheet" href="css/estilos.css">
  </head>
  <body>
    <mi-nav></mi-nav>
    <header>
      <h1>Usuarios</h1>
      <a href="usuarioNuevo.html">Agregar…</a>
    </header>
    <ul id="lista" class="lista con_imagen">
      <li>
        <mi-progreso></mi-progreso>
      </li>
    </ul>
    <mi-footer></mi-footer>
    <script type="module">
      import { cod, muestraError } from "./js/util.js";
      import { muestraPasatiempos } from "./js/navegacion.js";
      import {
        iniciaSesión, cargaRoles, noAutorizado
      } from "./js/seguridad.js";
      import { renderPrivilegio } from "./js/usuarios.js";
      import { urlStorage } from "./js/storage.js";
      const auth = firebase.auth();
      const firestore = firebase.firestore();
      auth.onAuthStateChanged(async usuario => {
        if (usuario && usuario.email) {
          const roles = await cargaRoles(usuario.email);
          if (roles.has("Administrador")) {
            muestraUsuarios();
          } else {
            noAutorizado();
          }
        } else {
          iniciaSesión();
        }
      },
        muestraError);
      function muestraUsuarios() {
        firestore.collection("Usuario")
          .onSnapshot(
            async querySnapshot => {
              let html = "";
              if (querySnapshot.size > 0) {
                /** @type {Promise<string>[]} */
                let usuarios = [];
                querySnapshot.forEach(docUsu => {
                  usuarios.append(renderUsuario(docUsu));
                });
                const renderDeUsuarios = await Promise.all(usuarios);
                // Junta el todos los elemento del arreglo en una cadena.
                html += renderDeUsuarios.join("");
              } else {
                html += /* html */
                  `<li>No hay usuarios registrados.</li>`;
              }
              lista.innerHTML = html;
            },
            e => {
              procesaError(e);
              muestraUsuarios();
            }
          );
      }
      /** Recupera el html de un usuario en base a su documento.
       * @param {Object} docUsu */
      async function renderUsuario(docUsu) {
        const dataUsu = docUsu.data();
        const img = urlStorage(docUsu.id);
        const pasatiempo = await renderPasatiempo(dataUsu.pasId)
        const privilegios = await renderPrivilegios(dataUsu.privIds);
        const parámetros = new URLSearchParams();
        parámetros.append("id", docUsu.id);
        return (/* html */
          `<li>
            <a href="usuario.html?${parámetros}">
              <span class="marco">
                <img src="${cod(img)}" alt="Falta el Avatar">
              </span>
              <span>
                <strong>${cod(docUsu.id)}</strong><br>
                ${cod(pasatiempo)}<br>
                ${privilegios}
              </span>
            </a>
          </li>`);
      }
      /** Recupera el html del pasatiempo en base a su id
       * @param {string} id */
      async function renderPasatiempo(id) {
        let html = "";
        if (id) {
          const docPas =
            await firestore.collection("Pasatiempo").doc(id).get();
          if (docPas.exists) {
            const data = docPas.data();
            return cod(data.nombre);
          }
        }
        return "-- Sin Pasatiempo --";
      }
      /** Recupera el html de los privilegios en base a sus id
       * @param {string[]} ids */
      async function renderPrivilegios(ids) {
        let html = "";
        if (ids.length > 0) {
          for (const id of ids) {
            const docPriv =
              await firestore.collection("Privilegio").doc(id).get();
            html += renderPrivilegio(docPriv);
          }
          return html;
        } else {
          return "-- Sin Privilegios --";
        }
      }
    </script>
  </body>
</html>